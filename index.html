<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>照片上傳至 Google Drive</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin-bottom: 20px; }
        #photoDropZone { 
            border: 2px dashed #ccc; 
            padding: 20px; 
            text-align: center; 
            cursor: pointer; 
            -webkit-tap-highlight-color: rgba(0,0,0,0);
            position: relative;
        }
        #photoDropZone.dragover { background-color: #f0f0f0; }
        #uploadStatus { margin-top: 20px; }
        #fileInput { 
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0;
            z-index: -1;
        }
        .upload-button {
            display: block;
            background: #4285f4;
            color: white;
            padding: 10px 20px;
            margin: 10px auto;
            border-radius: 4px;
            border: none;
            cursor: pointer;
        }
        .status-message {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="section" id="topPhotoArea">
        <h1>照片上傳平台</h1>
    </div>

    <div class="section" id="usernameArea">
        <label for="username">上傳者姓名：</label>
        <input type="text" id="username" placeholder="輸入姓名（例如 TT）" required>
    </div>

    <div class="section" id="messageArea">
        <label for="message">上傳者留言（可選）：</label>
        <textarea id="message" placeholder="輸入留言"></textarea>
    </div>

    <div class="section" id="photoDropArea">
        <div id="photoDropZone">
            <p>拖曳照片到此處，或點擊選擇照片</p>
            <input type="file" id="fileInput" accept="image/*" multiple>
        </div>
        <button id="selectPhotosBtn" class="upload-button">選擇照片</button>
        <div id="uploadStatus"></div>
    </div>

    <!-- 載入 Google Identity Services SDK -->
    <script src="https://accounts.google.com/gsi/client" async defer onerror="showError('Failed to load Google Identity Services SDK')"></script>
    <!-- 保留 gapi 用於 Drive API -->
    <script src="https://apis.google.com/js/api.js" async defer onerror="showError('Failed to load Google API JS')"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const CLIENT_ID = '1059727961676-mba09jlh8is4qrec86o8osrbd3cgld0l.apps.googleusercontent.com';
            const API_KEY = 'AIzaSyDW8iK2KvaYHHTUw-n5cN6n8AfVMm3Msd8';
            const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
            const SCOPES = 'https://www.googleapis.com/auth/drive.file';
            const FOLDER_ID = '1qnlf5S3Wt1QPJ2WupXcyTnJDm7rUDIrt';

            let accessToken;
            const dropZone = document.getElementById('photoDropZone');
            const fileInput = document.getElementById('fileInput');
            const selectPhotosBtn = document.getElementById('selectPhotosBtn');
            const uploadStatus = document.getElementById('uploadStatus');

            function showError(message) {
                console.error(message);
                const errorDiv = document.createElement('div');
                errorDiv.className = 'status-message error';
                errorDiv.textContent = `錯誤：${message}`;
                uploadStatus.appendChild(errorDiv);
            }

            function showSuccess(message) {
                const successDiv = document.createElement('div');
                successDiv.className = 'status-message success';
                successDiv.textContent = message;
                uploadStatus.appendChild(successDiv);
            }

            // 初始化 Google Drive API
            function initClient() {
                return new Promise((resolve, reject) => {
                    if (typeof gapi === 'undefined') {
                        reject(new Error('Google API library not loaded'));
                        return;
                    }
                    gapi.load('client', () => {
                        gapi.client.init({
                            apiKey: API_KEY,
                            discoveryDocs: DISCOVERY_DOCS,
                        }).then(() => {
                            console.log('Google Drive API 初始化成功');
                            resolve();
                        }).catch((error) => {
                            console.error('Google Drive API 初始化失敗:', error);
                            reject(new Error('Google Drive API 初始化失敗: ' + (error.message || JSON.stringify(error))));
                        });
                    });
                });
            }

            // 初始化 Google Identity Services
            function initGis() {
                return new Promise((resolve, reject) => {
                    if (typeof google === 'undefined') {
                        reject(new Error('Google Identity Services SDK not loaded'));
                        return;
                    }
                    const tokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: CLIENT_ID,
                        scope: SCOPES,
                        callback: (tokenResponse) => {
                            if (tokenResponse.access_token) {
                                accessToken = tokenResponse.access_token;
                                console.log('Access Token:', accessToken);
                                resolve();
                            } else {
                                console.error('Failed to get access token:', tokenResponse);
                                reject(new Error('Failed to get access token: ' + JSON.stringify(tokenResponse)));
                            }
                        },
                    });
                    tokenClient.requestAccessToken();
                });
            }

            // 確保拿到 Access Token
            async function ensureAccessToken() {
                if (!accessToken) {
                    try {
                        await initClient();
                        console.log('Client initialized');
                        await initGis();
                        console.log('GIS initialized, accessToken:', accessToken);
                    } catch (error) {
                        console.error('Failed to ensure access token:', error);
                        throw error;
                    }
                }
                return accessToken;
            }

            // 獲取下一個檔案編號
            async function getNextFileNumber(username) {
                try {
                    const response = await gapi.client.drive.files.list({
                        q: `'${FOLDER_ID}' in parents and name contains '${username}_'`,
                        fields: 'files(name)',
                    });
                    const files = response.result.files || [];
                    return files.length + 1;
                } catch (error) {
                    console.error('無法獲取檔案編號:', error);
                    throw new Error('無法獲取檔案編號: ' + (error.message || JSON.stringify(error)));
                }
            }

            // 上傳照片
            async function uploadFile(file, username, message, fileNumber) {
                const fileName = `${username}_${fileNumber}`;
                const metadata = {
                    name: fileName,
                    parents: [FOLDER_ID],
                    description: message || '無留言',
                };

                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', file);

                try {
                    const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                        method: 'POST',
                        headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
                        body: form,
                    });
                    console.log('Upload response status:', response.status);
                    if (response.ok) {
                        showSuccess(`上傳成功：${fileName}`);
                    } else {
                        const error = await response.json();
                        console.error('上傳失敗:', fileName, error);
                        showError(`上傳失敗：${fileName} - ${error.error?.message || JSON.stringify(error)}`);
                    }
                } catch (error) {
                    console.error('上傳過程中發生錯誤:', fileName, error);
                    showError(`上傳失敗：${fileName} - ${error.message || '未知錯誤'}`);
                }
            }

            // 處理文件上傳
            async function processFiles(files) {
                const username = document.getElementById('username').value.trim();
                const message = document.getElementById('message').value.trim();
                
                if (!username) {
                    alert('請輸入姓名！');
                    return;
                }
                
                if (!files || files.length === 0) {
                    showError('未選擇任何文件');
                    return;
                }

                try {
                    await ensureAccessToken();
                    let nextNumber = await getNextFileNumber(username);
                    
                    showSuccess(`開始上傳 ${files.length} 個文件...`);
                    
                    for (let i = 0; i < files.length; i++) {
                        console.log('Uploading file:', files[i].name);
                        await uploadFile(files[i], username, message, nextNumber + i);
                    }
                    
                    showSuccess('全部上傳完成！');
                } catch (error) {
                    console.error('上傳處理錯誤:', error);
                    showError(error.message || '未知錯誤');
                }
            }

            // 設置拖曳事件
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });
            
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover');
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                processFiles(e.dataTransfer.files);
            });

            // 專為 iOS Safari 優化的文件選擇處理
            selectPhotosBtn.addEventListener('click', (e) => {
                e.preventDefault();
                console.log('Select photos button clicked');
                
                // 直接觸發文件輸入點擊
                fileInput.click();
            });

            fileInput.addEventListener('change', (e) => {
                console.log('File input change event triggered');
                processFiles(e.target.files);
            });
        });
    </script>
</body>
</html>