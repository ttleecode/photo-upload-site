<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>照片上傳至 Google Drive</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin-bottom: 20px; }
        #photoDropZone { border: 2px dashed #ccc; padding: 20px; text-align: center; cursor: pointer; }
        #photoDropZone.dragover { background-color: #f0f0f0; }
        #uploadStatus { margin-top: 20px; }
    </style>
</head>
<body>
    <div class="section" id="topPhotoArea">
        <h1>照片上傳平台</h1>
    </div>

    <div class="section" id="usernameArea">
        <label for="username">上傳者姓名：</label>
        <input type="text" id="username" placeholder="輸入姓名（例如 TT）" required>
    </div>

    <div class="section" id="messageArea">
        <label for="message">上傳者留言（可選）：</label>
        <textarea id="message" placeholder="輸入留言"></textarea>
    </div>

    <div class="section" id="photoDropArea">
        <div id="photoDropZone">拖曳照片到此處，或點擊選擇照片</div>
        <div id="uploadStatus"></div>
    </div>

    <script src="https://apis.google.com/js/api.js"></script>
    <script>
        const CLIENT_ID = '1059727961676-mba09jlh8is4qrec86o8osrbd3cgld0l.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyDW8iK2KvaYHHTUw-n5cN6n8AfVMm3Msd8';
        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const FOLDER_ID = '1qnlf5S3Wt1QPJ2WupXcyTnJDm7rUDIrt';

        let tokenClient;
        let accessToken;

        // 初始化 Google API
        function initClient() {
            return new Promise((resolve, reject) => {
                gapi.load('client:auth2', () => {
                    gapi.client.init({
                        apiKey: API_KEY,
                        clientId: CLIENT_ID,
                        discoveryDocs: DISCOVERY_DOCS,
                        scope: SCOPES,
                    }).then(() => {
                        tokenClient = google.accounts.oauth2.initTokenClient({
                            client_id: CLIENT_ID,
                            scope: SCOPES,
                            callback: () => {}
                        });
                        console.log('Google API 初始化成功');
                        resolve();
                    }).catch((error) => {
                        console.error('Google API 初始化失敗:', error);
                        reject(error);
                    });
                });
            });
        }

        // 確保拿到 Access Token
        async function ensureAccessToken() {
            if (!tokenClient) {
                await initClient();
            }

            return new Promise((resolve, reject) => {
                if (accessToken) {
                    resolve();
                    return;
                }
                tokenClient.callback = (tokenResponse) => {
                    if (tokenResponse.access_token) {
                        accessToken = tokenResponse.access_token;
                        console.log('Access Token:', accessToken);
                        resolve();
                    } else {
                        console.error('Failed to get access token:', tokenResponse);
                        reject(new Error('Failed to get access token'));
                    }
                };
                tokenClient.requestAccessToken();
            });
        }

        // 獲取下一個檔案編號
        async function getNextFileNumber(username) {
            try {
                const response = await gapi.client.drive.files.list({
                    q: `'${FOLDER_ID}' in parents and name contains '${username}_'`,
                    fields: 'files(name)',
                });
                const files = response.result.files || [];
                return files.length + 1;
            } catch (error) {
                console.error('無法獲取檔案編號:', error);
                throw error;
            }
        }

        // 上傳照片
        async function uploadFile(file, username, message, fileNumber) {
            const fileName = `${username}_${fileNumber}`;
            const metadata = {
                name: fileName,
                parents: [FOLDER_ID],
                description: message || '無留言',
            };

            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', file);

            try {
                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
                    body: form,
                });

                if (response.ok) {
                    document.getElementById('uploadStatus').innerHTML += `<p>上傳成功：${fileName}</p>`;
                } else {
                    const error = await response.json();
                    console.error('上傳失敗:', error);
                    document.getElementById('uploadStatus').innerHTML += `<p>上傳失敗：${fileName} - ${error.error.message}</p>`;
                }
            } catch (error) {
                console.error('上傳過程中發生錯誤:', error);
                document.getElementById('uploadStatus').innerHTML += `<p>上傳失敗：${fileName} - ${error.message}</p>`;
            }
        }

        // 處理拖放和點擊上傳
        const dropZone = document.getElementById('photoDropZone');
        dropZone.addEventListener('click', () => document.getElementById('fileInput').click());
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', async (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');

            const username = document.getElementById('username').value.trim();
            const message = document.getElementById('message').value.trim();
            if (!username) {
                alert('請輸入姓名！');
                return;
            }

            const files = e.dataTransfer.files;
            try {
                await ensureAccessToken();
                let nextNumber = await getNextFileNumber(username);
                for (let i = 0; i < files.length; i++) {
                    await uploadFile(files[i], username, message, nextNumber + i);
                }
            } catch (error) {
                document.getElementById('uploadStatus').innerHTML += `<p>錯誤：${error.message}</p>`;
            }
        });

        // 隱藏的檔案輸入
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.id = 'fileInput';
        fileInput.multiple = true;
        fileInput.accept = 'image/*';
        fileInput.style.display = 'none';
        document.body.appendChild(fileInput);

        fileInput.addEventListener('change', async (e) => {
            const username = document.getElementById('username').value.trim();
            const message = document.getElementById('message').value.trim();
            if (!username) {
                alert('請輸入姓名！');
                return;
            }

            const files = e.target.files;
            try {
                await ensureAccessToken();
                let nextNumber = await getNextFileNumber(username);
                for (let i = 0; i < files.length; i++) {
                    await uploadFile(files[i], username, message, nextNumber + i);
                }
            } catch (error) {
                document.getElementById('uploadStatus').innerHTML += `<p>錯誤：${error.message}</p>`;
            }
        });
    </script>
</body>
</html>