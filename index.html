<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>照片上傳至 Google Drive</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin-bottom: 20px; }
        #photoDropZone { border: 2px dashed #ccc; padding: 20px; text-align: center; cursor: pointer; }
        #photoDropZone.dragover { background-color: #f0f0f0; }
        #uploadStatus { margin-top: 20px; }
    </style>
</head>
<body>
    <div class="section" id="topPhotoArea">
        <h1>照片上傳平台</h1>
    </div>

    <div class="section" id="usernameArea">
        <label for="username">上傳者姓名：</label>
        <input type="text" id="username" placeholder="輸入姓名（例如 TT)" required>
    </div>

    <div class="section" id="messageArea">
        <label for="message">上傳者留言（可選）：</label>
        <textarea id="message" placeholder="輸入留言"></textarea>
    </div>

    <div class="section" id="photoDropArea">
        <div id="photoDropZone">拖曳照片到此處，或點擊選擇照片</div>
        <div id="uploadStatus"></div>
    </div>

    <!-- 載入 Google Identity Services SDK -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <!-- 保留 gapi 用於 Drive API -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script>
        const CLIENT_ID = '1059727961676-mba09jlh8is4qrec86o8osrbd3cgld0l.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyDW8iK2KvaYHHTUw-n5cN6n8AfVMm3Msd8';
        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const FOLDER_ID = '1qnlf5S3Wt1QPJ2WupXcyTnJDm7rUDIrt';

        let accessToken;

        // 初始化 Google Drive API
        function initClient() {
            return new Promise((resolve, reject) => {
                gapi.load('client', () => {
                    gapi.client.init({
                        apiKey: API_KEY,
                        discoveryDocs: DISCOVERY_DOCS,
                    }).then(() => {
                        console.log('Google Drive API 初始化成功');
                        resolve();
                    }).catch((error) => {
                        console.error('Google Drive API 初始化失敗:', error);
                        let errorMessage = error.message || JSON.stringify(error);
                        console.error('詳細錯誤:', errorMessage);
                        reject(new Error('Google Drive API 初始化失敗: ' + errorMessage));
                    });
                });
            });
        }

        // 初始化 Google Identity Services
        function initGis() {
            return new Promise((resolve, reject) => {
                const client = google.accounts.oauth2.initCodeClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: (response) => {
                        if (response.code) {
                            // 使用 code 交換 access token（需要後端支持，此處簡化為假設已獲取）
                            console.log('Authorization code:', response.code);
                            // 注意：實際應用中需要後端交換 token，此處僅模擬
                            fetchToken(response.code).then(resolve).catch(reject);
                        } else {
                            reject(new Error('Failed to get authorization code'));
                        }
                    },
                });
                client.requestCode(); // 觸發 OAuth 流程
            });
        }

        // 模擬後端交換 token（實際應用需要後端實現）
        async function fetchToken(code) {
            const response = await fetch('/exchangeToken', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code: code, client_id: CLIENT_ID, client_secret: '你的 client_secret', redirect_uri: 'postmessage' }),
            });
            const data = await response.json();
            accessToken = data.access_token;
            console.log('Access Token:', accessToken);
            return accessToken;
        }

        // 確保拿到 Access Token
        async function ensureAccessToken() {
            if (!accessToken) {
                await initClient();
                await initGis(); // 觸發 OAuth 流程
            }
            return accessToken;
        }

        // 獲取下一個檔案編號
        async function getNextFileNumber(username) {
            try {
                const response = await gapi.client.drive.files.list({
                    q: `'${FOLDER_ID}' in parents and name contains '${username}_'`,
                    fields: 'files(name)',
                });
                const files = response.result.files || [];
                return files.length + 1;
            } catch (error) {
                console.error('無法獲取檔案編號:', error);
                throw new Error('無法獲取檔案編號: ' + (error.message || JSON.stringify(error)));
            }
        }

        // 上傳照片
        async function uploadFile(file, username, message, fileNumber) {
            const fileName = `${username}_${fileNumber}`;
            const metadata = {
                name: fileName,
                parents: [FOLDER_ID],
                description: message || '無留言',
            };

            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', file);

            try {
                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
                    body: form,
                });

                if (response.ok) {
                    document.getElementById('uploadStatus').innerHTML += `<p>上傳成功：${fileName}</p>`;
                } else {
                    const error = await response.json();
                    console.error('上傳失敗:', error);
                    document.getElementById('uploadStatus').innerHTML += `<p>上傳失敗：${fileName} - ${error.error?.message || JSON.stringify(error)}</p>`;
                }
            } catch (error) {
                console.error('上傳過程中發生錯誤:', error);
                document.getElementById('uploadStatus').innerHTML += `<p>上傳失敗：${fileName} - ${error.message || '未知錯誤'}</p>`;
            }
        }

        // 處理拖放和點擊上傳
        const dropZone = document.getElementById('photoDropZone');
        dropZone.addEventListener('click', () => document.getElementById('fileInput').click());
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', async (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');

            const username = document.getElementById('username').value.trim();
            const message = document.getElementById('message').value.trim();
            if (!username) {
                alert('請輸入姓名！');
                return;
            }

            const files = e.dataTransfer.files;
            try {
                await ensureAccessToken();
                let nextNumber = await getNextFileNumber(username);
                for (let i = 0; i < files.length; i++) {
                    await uploadFile(files[i], username, message, nextNumber + i);
                }
            } catch (error) {
                console.error('拖放上傳錯誤:', error);
                document.getElementById('uploadStatus').innerHTML += `<p>錯誤：${error.message || '未知錯誤'}</p>`;
            }
        });

        // 隱藏的檔案輸入
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.id = 'fileInput';
        fileInput.multiple = true;
        fileInput.accept = 'image/*';
        fileInput.style.display = 'none';
        document.body.appendChild(fileInput);

        fileInput.addEventListener('change', async (e) => {
            const username = document.getElementById('username').value.trim();
            const message = document.getElementById('message').value.trim();
            if (!username) {
                alert('請輸入姓名！');
                return;
            }

            const files = e.target.files;
            try {
                await ensureAccessToken();
                let nextNumber = await getNextFileNumber(username);
                for (let i = 0; i < files.length; i++) {
                    await uploadFile(files[i], username, message, nextNumber + i);
                }
            } catch (error) {
                console.error('點擊上傳錯誤:', error);
                document.getElementById('uploadStatus').innerHTML += `<p>錯誤：${error.message || '未知錯誤'}</p>`;
            }
        });
    </script>
</body>
</html>